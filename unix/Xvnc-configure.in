#!/bin/sh
# Xvnc-configure
#
# This script interfaces the XFree86 build system with CMake

CPU=@CPU_TYPE@
CC="@CMAKE_C_COMPILER@"
GCC=@CMAKE_COMPILER_IS_GNUCC@
GCC34=@GCC34@
CFLAGS="@EFFECTIVE_C_FLAGS@"
LDFLAGS="@CMAKE_EXE_LINKER_FLAGS@"
JPEGINC="-I@TJPEG_INCLUDE_DIR@"
JPEGLINK="@TJPEG_LIBRARY@"

SYSNAME=`uname -s`

REV=`uname -r`

if [ "$SYSNAME" != Darwin ]
then
    REV=`echo $REV | sed -e 's/^V//' -e 's/-.*$//'`
fi

MAJOR=`echo $REV | awk -F. 'NF < 1 {print "0"} {print $1}'`
MINOR=`echo $REV | awk -F. 'NF < 2 {print "0"} {print $2}'`
TEENY=`echo $REV | awk -F. 'NF < 3 {print "0"} {print $3}'`

echo "#define OSName $SYSNAME" > config/cf/platform.def
echo "#define OSMajorVersion $MAJOR" >> config/cf/platform.def
echo "#define OSMinorVersion $MINOR" >> config/cf/platform.def
echo "#define OSTeenyVersion $TEENY" >> config/cf/platform.def
echo "#define LinuxCLibMajorVersion 6" >> config/cf/platform.def
if [ "$GCC" = "1" ]; then
    echo "#define HasGcc2 YES" >> config/cf/platform.def
fi
if [ "$GCC34" = "1" ]; then
    echo "#define HasGcc34 YES" >> config/cf/platform.def
fi
case "$CPU" in
    i*86)
        echo "#define i386Architecture" >> config/cf/platform.def
        echo "#undef x86_64Architecture" >> config/cf/platform.def
        ;;
    x86_64 | amd64)
        echo "#define x86_64Architecture" >> config/cf/platform.def
        ;;
esac
if [ ! "$JPEGINC" = "" ]; then
    echo "#define JPEGIncludeFlags $JPEGINC" >>config/cf/platform.def
fi
if [ ! "$JPEGLINK" = "" ]; then
    echo "#define JPEGLibraryFlags $JPEGLINK" >>config/cf/platform.def
fi
echo '#define ZlibIncludeDir -I@CMAKE_SOURCE_DIR@/common/zlib' >>config/cf/platform.def
echo '#define VncIncludeDir -I@CMAKE_SOURCE_DIR@/unix/include -I@CMAKE_SOURCE_DIR@/common/rfb ZlibIncludeDir' >>config/cf/platform.def

SVR4FLAGS=
if [ "`uname -s`" = "SunOS" ]; then
    SVR4FLAGS=-DSVR4;
fi
cd config/imake
make -f Makefile.ini CC="$CC" CDEBUGFLAGS="$CFLAGS $SVR4FLAGS" EXTRA_LDOPTIONS="$LDFLAGS"
cd ../..
config/imake/imake -I./config/cf -DTOPDIR=./ -DCURDIR=.
make Makefiles CC="$CC" CDEBUGFLAGS="$CFLAGS" EXTRA_LDOPTIONS="$LDFLAGS"
make includes CC="$CC" CDEBUGFLAGS="$CFLAGS" EXTRA_LDOPTIONS="$LDFLAGS"
cd config/makedepend
make CC="$CC" CDEBUGFLAGS="$CFLAGS" EXTRA_LDOPTIONS="$LDFLAGS"
cd ../..
cd config/util
make CC="$CC" CDEBUGFLAGS="$CFLAGS" EXTRA_LDOPTIONS="$LDFLAGS"
cd ../..
make depend CC="$CC" CDEBUGFLAGS="$CFLAGS" EXTRA_LDOPTIONS="$LDFLAGS"

exit 0
